var bemxjst = require('bem-xjst'),
    bemhtml = 'oninit(function(t,i){function s(t,i){this.ctx="undefined"==typeof t?"":t,this.apply=i,this._str="";var s=this;this._buf={push:function(){var t=o.call(arguments).join("");s._str+=t},join:function(){return this._str}},this._=this,this._start=!0,this._mode="",this._listLength=0,this._notNewList=!1,this.position=0,this.block=e,this.elem=e,this.mods=e,this.elemMods=e}var e,n={},r=Object.prototype.toString,o=Array.prototype.slice,a=Array.isArray||function(t){return"[object Array]"===r.call(t)},l={area:1,base:1,br:1,col:1,command:1,embed:1,hr:1,img:1,input:1,keygen:1,link:1,meta:1,param:1,source:1,wbr:1};!function(t){function i(t,i){var s=r+t;return i!==!0&&(s+=r+i),s}function s(t,s,e){var n=t;return e&&(n+=i(s,e)),n}function n(t,e,n,r){var a=s(t)+o+e;return r&&(a+=i(n,r)),a}var r="_",o="__",a="[a-zA-Z0-9-]+";t.INTERNAL={NAME_PATTERN:a,MOD_DELIM:r,ELEM_DELIM:o,buildModPostfix:i,buildClass:function(t,i,r,o){var a=typeof r;if("string"===a||"boolean"===a){var l=typeof o;"string"!==l&&"boolean"!==l&&(o=r,r=i,i=e)}else"undefined"!==a?r=e:i&&"string"!=typeof i&&(i=e);return i||r?i?n(t,i,r,o):s(t,r,o):t},buildModsClasses:function(t,i,e){var r="";if(e){var o;for(o in e)if(e.hasOwnProperty(o)){var a=e[o];(a||0===a)&&("boolean"!=typeof a&&(a+=""),r+=" "+(i?n(t,i,o,a):s(t,o,a)))}}return r},buildClasses:function(t,i,e){var r="";return r+=i?n(t,i):s(t),r+=this.buildModsClasses(t,i,e)}}}(n);var h=function(){var t={\'"\':"&quot;","&":"&amp;","<":"&lt;",">":"&gt;"},i=function(i){return t[i]||i};return function(t){return t=new RegExp(t,"g"),function(s){return(""+s).replace(t,i)}}}();i.BEMContext=s,s.prototype.isArray=a,s.prototype.isSimple=function(t){if(!t||t===!0)return!0;var i=typeof t;return"string"===i||"number"===i},s.prototype.isShortTag=function(t){return l.hasOwnProperty(t)},s.prototype.extend=function(t,i){if(!t||!i)return t||i;var s,e={};for(s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);for(s in i)i.hasOwnProperty(s)&&(e[s]=i[s]);return e},s.prototype.identify=function(){var t=0,i=+new Date,s="__"+i,e=function(){return"uniq"+i+ ++t};return function(t,i){return t?i||t[s]?t[s]:t[s]=e():e()}}(),s.prototype.xmlEscape=h("[&<>]"),s.prototype.attrEscape=h(\'["&<>]\'),s.prototype.BEM=n,s.prototype.isFirst=function(){return 1===this.position},s.prototype.isLast=function(){return this.position===this._listLength},s.prototype.generateId=function(){return this.identify(this.ctx)};var c=t.apply;t.apply=s.apply=function(t){var i=new s(t||this,c);return i.apply(),i._str},s.prototype.reapply=s.apply}),match(""===this._mode)(match()(function(){this.ctx||(this.ctx={});var t=this.ctx.block,i=this.ctx.elem,s=this._currBlock||this.block;local("default",{block:t||(i?s:void 0),_currBlock:t||i?void 0:s,elem:i,mods:t?this.ctx.mods||(this.ctx.mods={}):this.mods,elemMods:this.ctx.elemMods||{}})(function(){this.block||this.elem?this.position=(this.position||0)+1:this._listLength--,apply()})}),match(function(){return this.isArray(this.ctx)})(function(){var t=this.ctx,i=t.length,s=0,e=this.position,n=this._notNewList;for(n?this._listLength+=i-1:(this.position=0,this._listLength=i),this._notNewList=!0;i>s;)apply({ctx:t[s++]});n||(this.position=e)}),match(!this.ctx)(function(){this._listLength--}),match(function(){return this.isSimple(this.ctx)})(function(){this._listLength--;var t=this.ctx;(t&&t!==!0||0===t)&&(this._str+=t+"")}),match(this.ctx&&this.ctx._vow)(function(){applyCtx(this.ctx._value)})),def()(function(){var t,i,s,e=this.BEM.INTERNAL,n=this.ctx;local({_str:""})(function(){var r=this.block;if(i=apply("tag"),"undefined"!=typeof i||(i=n.tag),"undefined"!=typeof i||(i="div"),i){var o,a;r&&n.js!==!1&&(a=apply("js"),a=a?this.extend(n.js,a===!0?{}:a):n.js===!0?{}:n.js,a&&((o={})[e.buildClass(r,n.elem)]=a)),this._str+="<"+i,t=apply("bem"),"undefined"!=typeof t||(t="undefined"!=typeof n.bem?n.bem:n.block||n.elem);var l=apply("cls");l||(l=n.cls);var h=n.block&&o&&!n.elem;if(t||l){if(this._str+=\' class="\',t){this._str+=e.buildClasses(r,n.elem,n.elemMods||n.mods);var c=apply("mix");if(n.mix&&(c=c?[].concat(c,n.mix):n.mix),c){var p={},u=function(t,i){return(t||"")+"__"+(i||"")};p[u(r,this.elem)]=!0,this.isArray(c)||(c=[c]);for(var f=0;f<c.length;f++){var m=c[f],d=m.block||m.elem,y=m.block||m._block||this.block,_=m.elem||m._elem||this.elem;if(d&&(this._str+=" "),this._str+=e[d?"buildClasses":"buildModsClasses"](y,m.elem||m._elem||(m.block?void 0:this.elem),m.elemMods||m.mods),m.js&&((o||(o={}))[e.buildClass(y,m.elem)]=m.js===!0?{}:m.js,h||(h=y&&!m.elem)),d&&!p[u(y,_)]){p[u(y,_)]=!0;var v=apply("mix",{block:y,elem:_});if(v)for(var b=0;b<v.length;b++){var x=v[b];(x.block||x.elem)&&p[u(x.block,x.elem)]||(x._block=y,x._elem=_,c.splice(f+1,0,x))}}}}}l&&(this._str+=t?" "+l:l),this._str+=h?\' i-bem"\':\'"\'}t&&o&&(this._str+=\' data-bem="\'+this.attrEscape(JSON.stringify(o))+\'"\');var g=apply("attrs");if(g=this.extend(g,n.attrs)){var k,L;for(k in g)L=g[k],"undefined"!=typeof L&&(this._str+=" "+k+\'="\'+this.attrEscape(this.isSimple(L)?L:this.reapply(L))+\'"\')}}if(this.isShortTag(i))this._str+="/>";else{i&&(this._str+=">");var M=apply("content");(M||0===M)&&(t=r||this.elem,apply("",{_notNewList:!1,position:t?1:this.position,_listLength:t?1:this._listLength,ctx:M})),i&&(this._str+="</"+i+">")}s=this._str}),this._buf.push(s)}),tag()(void 0),attrs()(void 0),cls()(void 0),js()(void 0),bem()(void 0),mix()(void 0),content()(function(){return this.ctx.content});';

window.compile = function(source) {
    return bemxjst.generate(bemhtml + source, {
        wrap: true,
        exportName: 'BEMHTML',
        optimize: false,
        cache: false,
        modulesDeps: false
    });
};
